// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String @id @default(cuid())
  email          String @unique
  name           String
  hashedPassword String
  role           String @default("USER") // "ADMIN", "USER", "MANAGER", "VIEWER"

  // Additional user details
  qid         String?
  joiningDate DateTime?
  department  String?
  position    String?
  phone       String?

  // Registration approval
  status     String    @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  approvedBy String?
  approvedAt DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobOrder {
  id                  String    @id @default(cuid())
  jobNumber           String
  productName         String // Main description
  drawingRef          String?
  clientName          String?
  contactPerson       String?
  phone               String?
  clientContactPerson String?
  clientContactPhone  String?
  lpoContractNo       String?
  priority            String?   @default("MEDIUM") // HIGH, MEDIUM, LOW
  foreman             String?
  workScope           String? // Legacy field - kept for backwards compatibility
  scopeOfWorks        String? // JSON array of selected work types
  qaQcInCharge        String?
  discount            Float     @default(0)
  roundOff            Float     @default(0)
  isDeleted           Boolean   @default(false)
  deletedAt           DateTime?
  deletedBy           String?
  createdBy           String?
  lastEditedBy        String?
  lastEditedAt        DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  materialRequests MaterialRequest[]
  editHistory      JobOrderEditHistory[]
  items            JobOrderItem[]

  @@unique([jobNumber, isDeleted])
}

model JobOrderItem {
  id         String   @id @default(cuid())
  jobOrderId String
  jobOrder   JobOrder @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)

  workDescription String
  quantity        Float
  unit            String
  unitPrice       Float
  totalPrice      Float // quantity * unitPrice

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model JobOrderEditHistory {
  id          String   @id @default(cuid())
  jobOrderId  String
  jobOrder    JobOrder @relation(fields: [jobOrderId], references: [id], onDelete: Cascade)
  editedBy    String
  editedAt    DateTime @default(now())
  changesMade String // JSON string of changes
}

model MaterialRequest {
  id             String    @id @default(cuid())
  requestNumber  String    @unique
  requestContext String    @default("JOB_ORDER") // "JOB_ORDER", "WORKSHOP", "MACHINERY", "MAINTENANCE"
  jobOrderId     String?
  jobOrder       JobOrder? @relation(fields: [jobOrderId], references: [id])
  assetId        String?
  asset          Asset?    @relation(fields: [assetId], references: [id])

  materialType String // "RAW_MATERIAL" or "CONSUMABLE"
  itemName     String
  description  String
  quantity     Float
  unit         String

  reasonForRequest    String
  requiredDate        DateTime
  preferredSupplier   String?
  stockQtyInInventory Float    @default(0)

  urgencyLevel String @default("NORMAL") // "LOW", "NORMAL", "HIGH", "CRITICAL"
  status       String @default("PENDING") // "PENDING", "IN_PROCUREMENT", "ORDERED", "PARTIALLY_RECEIVED", "RECEIVED", "CANCELLED"

  requestedBy String
  requestedAt DateTime @default(now())

  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  createdBy    String?
  lastEditedBy String?
  lastEditedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  procurementActions ProcurementAction[]
  purchaseOrderItems PurchaseOrderItem[]
  statusHistory      StatusHistory[]
  editHistory        MaterialRequestEditHistory[]
  items              MaterialRequestItem[]
}

model MaterialRequestItem {
  id                String          @id @default(cuid())
  materialRequestId String
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id], onDelete: Cascade)

  itemName            String
  description         String
  quantity            Float
  unit                String
  stockQtyInInventory Float          @default(0)
  reasonForRequest    String?
  urgencyLevel        String         @default("NORMAL")
  requiredDate        DateTime?
  preferredSupplier   String?
  inventoryItemId     String?
  inventoryItem       InventoryItem? @relation(fields: [inventoryItemId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MaterialRequestEditHistory {
  id                String          @id @default(cuid())
  materialRequestId String
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id], onDelete: Cascade)
  editedBy          String
  editedAt          DateTime        @default(now())
  changesMade       String // JSON string of changes
}

model ProcurementAction {
  id                String          @id @default(cuid())
  materialRequestId String
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id])

  actionType String // "ASSIGNED", "QUOTATION_REQUESTED", "QUOTATION_RECEIVED", "PO_CREATED", "NOTE"
  actionBy   String
  actionDate DateTime @default(now())
  notes      String?

  quotationAmount  Float?
  supplierName     String?
  expectedDelivery DateTime?

  isDeleted    Boolean   @default(false)
  deletedAt    DateTime?
  deletedBy    String?
  lastEditedBy String?
  lastEditedAt DateTime?

  createdAt   DateTime                       @default(now())
  editHistory ProcurementActionEditHistory[]
}

model ProcurementActionEditHistory {
  id                  String            @id @default(cuid())
  procurementActionId String
  procurementAction   ProcurementAction @relation(fields: [procurementActionId], references: [id], onDelete: Cascade)
  editedBy            String
  editedAt            DateTime          @default(now())
  changesMade         String // JSON string of changes
}

model PurchaseOrder {
  id              String  @id @default(cuid())
  poNumber        String  @unique
  supplierName    String
  supplierContact String?

  orderDate        DateTime  @default(now())
  expectedDelivery DateTime?
  actualDelivery   DateTime?

  totalAmount Float
  status      String @default("PENDING") // "PENDING", "SENT", "ACKNOWLEDGED", "PARTIALLY_DELIVERED", "DELIVERED", "CANCELLED"

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items PurchaseOrderItem[]
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  materialRequestId String
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id])

  orderedQuantity  Float
  receivedQuantity Float @default(0)
  unitPrice        Float
  totalPrice       Float

  deliveryStatus String @default("PENDING") // "PENDING", "PARTIAL", "DELIVERED"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receipts MaterialReceipt[]
}

model MaterialReceipt {
  id                  String            @id @default(cuid())
  purchaseOrderItemId String
  purchaseOrderItem   PurchaseOrderItem @relation(fields: [purchaseOrderItemId], references: [id])

  receivedQuantity Float
  receivedDate     DateTime @default(now())
  receivedBy       String

  qualityStatus   String  @default("PENDING") // "PENDING", "APPROVED", "REJECTED"
  storageLocation String?
  notes           String?

  createdAt DateTime @default(now())
}

model StatusHistory {
  id                String          @id @default(cuid())
  materialRequestId String
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id])

  oldStatus String
  newStatus String
  changedBy String
  changedAt DateTime @default(now())
  notes     String?
}

model Supplier {
  id            String  @id @default(cuid())
  name          String  @unique
  tradingName   String?
  contactPerson String?
  email         String?
  phone         String?
  address       String?
  website       String?
  rating        Float?

  isActive        Boolean @default(true)
  paymentTerms    String?
  leadTimeDays    Int?
  defaultCurrency String? @default("QAR")
  taxId           String?
  tradeLicense    String?
  preferred       Boolean @default(false)
  notes           String?

  // Relations
  supplierPrices   SupplierPrice[]
  supplierQuotes   SupplierQuote[]
  enquiryResponses EnquiryResponse[] @relation("EnquiryResponseToSupplier")
  notifications    Notification[]    @relation("NotificationToSupplier")

  // New relations
  contacts       SupplierContact[]
  capabilities   SupplierCapability[]
  certifications SupplierCertification[]
  documents      SupplierDocument[]
  references     SupplierReference[]
  bankDetails    SupplierBankDetails?

  status SupplierStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SupplierStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name      String
  role      String?
  email     String?
  phone     String?
  isPrimary Boolean @default(false)
  notes     String?

  createdAt DateTime @default(now())
}

model SupplierCapability {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  category String // e.g., "PROCESS", "MATERIAL", "SERVICE"
  name     String // e.g., "Welding", "Plate Rolling", "S355"
  details  String?
  capacity String? // textual capacity or numbers

  createdAt DateTime @default(now())
}

model SupplierCertification {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name       String
  certNumber String?
  issuedBy   String?
  validFrom  DateTime?
  validTo    DateTime?
  document   SupplierDocument? @relation(fields: [documentId], references: [id])
  documentId String?

  createdAt DateTime @default(now())
}

model SupplierDocument {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  type                  String // e.g., "TRADE_LICENSE", "INSURANCE", "QA_CERT"
  filename              String
  url                   String
  uploadedBy            String?
  uploadedAt            DateTime                @default(now())
  expiresAt             DateTime?
  notes                 String?
  SupplierCertification SupplierCertification[]
}

model SupplierReference {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  clientName   String
  projectName  String?
  contactName  String?
  contactPhone String?
  notes        String?

  createdAt DateTime @default(now())
}

model SupplierBankDetails {
  id         String   @id @default(cuid())
  supplierId String   @unique
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  bankName    String?
  accountName String?
  iban        String?
  swift       String?
  currency    String?
  notes       String?

  createdAt DateTime @default(now())
}

model PrintTemplate {
  id           String   @id @default(cuid())
  name         String
  entityType   String // JOB_ORDER | MATERIAL_REQUEST | PURCHASE_ORDER
  htmlTemplate String
  mapping      Json?
  isDefault    Boolean  @default(false)
  createdBy    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model SupplierPrice {
  id            String    @id @default(cuid())
  supplierId    String
  supplier      Supplier  @relation(fields: [supplierId], references: [id])
  itemKey       String // item code or materialRequestItem id
  unitPrice     Float
  currency      String    @default("QAR")
  effectiveFrom DateTime?
  createdAt     DateTime  @default(now())
}

model POPreparation {
  id        String   @id @default(cuid())
  createdBy String
  items     Json // { itemKey, qty, unit }
  status    String   @default("DRAFT")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  enquiries      Enquiry[]       @relation("EnquiryToPrep")
  supplierQuotes SupplierQuote[] @relation("SupplierQuoteToPrep")
}

model SupplierQuote {
  id         String        @id @default(cuid())
  prepId     String
  prep       POPreparation @relation(fields: [prepId], references: [id], name: "SupplierQuoteToPrep")
  supplierId String
  supplier   Supplier      @relation(fields: [supplierId], references: [id])
  quoteJson  String // JSON of quoted items and prices
  total      Float
  createdAt  DateTime      @default(now())
}

model Enquiry {
  id            String            @id @default(cuid())
  prepId        String
  prep          POPreparation     @relation(fields: [prepId], references: [id], name: "EnquiryToPrep")
  createdBy     String
  supplierIds   String[]
  message       String?
  status        String            @default("DRAFT") // DRAFT | SENT | RESPONSES_RECEIVED | CLOSED
  sentAt        DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  responses     EnquiryResponse[]
  notifications Notification[]
}

model EnquiryResponse {
  id          String   @id @default(cuid())
  enquiryId   String
  enquiry     Enquiry  @relation(fields: [enquiryId], references: [id])
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], name: "EnquiryResponseToSupplier")
  quoteJson   Json
  total       Float
  attachments Json?
  respondedAt DateTime @default(now())
}

model Notification {
  id             String    @id @default(cuid())
  enquiryId      String?
  enquiry        Enquiry?  @relation(fields: [enquiryId], references: [id])
  supplierId     String?
  supplier       Supplier? @relation(fields: [supplierId], references: [id], name: "NotificationToSupplier")
  channel        String // EMAIL | SMS
  to             String
  status         String    @default("PENDING") // PENDING | SENT | FAILED
  providerResult Json?
  sentAt         DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model InventoryItem {
  id           String  @id @default(cuid())
  itemName     String  @unique
  description  String?
  currentStock Float
  unit         String
  minimumStock Float   @default(0)
  location     String?

  lastUpdated          DateTime              @updatedAt
  createdAt            DateTime              @default(now())
  materialRequestItems MaterialRequestItem[]
}

model Asset {
  id               String            @id @default(cuid())
  code             String            @unique
  name             String
  category         String?
  location         String?
  status           String?           @default("ACTIVE")
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  materialRequests MaterialRequest[]
}
